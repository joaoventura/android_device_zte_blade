From 41cc8e2a8eede96da26346c99cdc20c4dd2bda19 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jo=C3=A3o=20Ventura?= <joaojonesventura@gmail.com>
Date: Mon, 17 Dec 2012 10:48:35 +0000
Subject: [PATCH] Email insecure attachments

Change-Id: Ie1f9666b033dee2feb8fb01d264a927c620d0cb5
---
 res/values-pt-rPT/strings.xml             |   11 ++--
 res/values/strings.xml                    |    5 ++
 res/xml/general_preferences.xml           |    7 +++
 src/com/android/email/AttachmentInfo.java |   82 +++++++++++++++++------------
 src/com/android/email/Preferences.java    |    5 ++
 5 files changed, 71 insertions(+), 39 deletions(-)

diff --git a/res/values-pt-rPT/strings.xml b/res/values-pt-rPT/strings.xml
index 5df6f33..a6d9005 100644
--- a/res/values-pt-rPT/strings.xml
+++ b/res/values-pt-rPT/strings.xml
@@ -290,7 +290,7 @@
     <string name="account_setup_exchange_ssl_label" msgid="6704105469083211236">"Utilizar ligação segura (SSL)"</string>
     <string name="account_setup_exchange_trust_certificates_label" msgid="6232880757633882678">"Aceitar todos os certificados SLL"</string>
     <string name="account_setup_exchange_certificate_title" msgid="8473793588405277962">"Certificado do cliente"</string>
-    <string name="account_setup_exchange_select_certificate" msgid="1536103662037268683">"Selecionar"</string>
+    <string name="account_setup_exchange_select_certificate" msgid="1536103662037268683">"Seleccionar"</string>
     <string name="account_setup_exchange_use_certificate" msgid="8690682770083161349">"Utilizar certificado de cliente"</string>
     <string name="account_setup_exchange_remove_certificate" msgid="5633249155510301766">"Remover"</string>
     <string name="account_setup_exchange_no_certificate" msgid="1119542961954780872">"Nenhum"</string>
@@ -405,7 +405,7 @@
     <string name="mailbox_settings_mailbox_check_frequency_label" msgid="1246075442689328906">"Verificar frequência"</string>
     <string name="mailbox_settings_mailbox_sync_window_label" msgid="2957945231022052672">"Dias para sincronização"</string>
     <string name="account_shortcut_picker_name" msgid="1994861845225243190">"Conta de e-mail"</string>
-    <string name="account_shortcut_picker_title" msgid="1039929224016048015">"Selecionar uma conta"</string>
+    <string name="account_shortcut_picker_title" msgid="1039929224016048015">"Seleccionar uma conta"</string>
     <string name="mailbox_shortcut_picker_title" msgid="4152973927804882131">"Selecione uma pasta"</string>
     <string name="toast_account_not_found" msgid="8144242451730692816">"Não foi possível localizar a conta. Pode ter sido removida."</string>
     <string name="toast_mailbox_not_found" msgid="4960014581292378895">"Não foi possível localizar a pasta. Pode ter sido removida."</string>
@@ -425,7 +425,7 @@
     <string name="header_label_general_preferences" msgid="9204600297009680176">"Geral"</string>
     <string name="category_general_preferences" msgid="2742423840964045801">"Aplicação"</string>
     <string name="general_preference_auto_advance_label" msgid="213945004511666631">"Avanço automático"</string>
-    <string name="general_preference_auto_advance_summary" msgid="6483439980032715119">"Selecionar o ecrã a apresentar após eliminar uma mensagem"</string>
+    <string name="general_preference_auto_advance_summary" msgid="6483439980032715119">"Seleccionar o ecrã a apresentar após eliminar uma mensagem"</string>
     <string name="general_preference_auto_advance_dialog_title" msgid="5405052109452503909">"Avançar para"</string>
     <string name="general_preference_auto_advance_newer" msgid="1336720027570509885">"Mensagem mais recente"</string>
     <string name="general_preference_auto_advance_older" msgid="8273143493185128646">"Mensagem mais antiga"</string>
@@ -446,7 +446,7 @@
     <string name="general_preference_text_zoom_huge" msgid="4270503132355963031">"Muito grande"</string>
     <string name="general_preference_reply_all_label" msgid="7806833609810003510">"Responder a todos"</string>
     <string name="general_preference_reply_all_summary" msgid="9191932552604733245">"Predefinir \"Responder a todos\" para mensagens de resposta"</string>
-    <string name="general_preferences_clear_trusted_senders_title" msgid="507988226277210305">"Perguntar para mostrar fotografias"</string>
+    <string name="general_preferences_clear_trusted_senders_title" msgid="507988226277210305">"Mostrar fotografias"</string>
     <string name="general_preferences_clear_trusted_senders_summary" msgid="2648501128162793879">"As fotografias em mensagens não serão apresentadas automaticamente"</string>
     <string name="trusted_senders_cleared" msgid="4762002183756251723">"\"Mostrar imagens\" desmarcada."</string>
     <string name="position_of_count" msgid="7989353140376877792">"<xliff:g id="ID_1">%1$d</xliff:g> de <xliff:g id="ID_2">%2$s</xliff:g>"</string>
@@ -467,4 +467,7 @@
     <string name="search_slow_warning_message" msgid="8494483410797387903">"Alguns servidores podem demorar algum tempo."</string>
     <string name="action_bar_mailbox_list_title" msgid="7484457755531286333">"Pastas"</string>
     <string name="require_manual_sync_message" msgid="7777357288642785955">"A sincronização em segundo plano desta conta está desativada quando está em roaming."</string>
+    <!-- Allow untrusted attachments -->
+    <string name="general_preference_allow_untrusted_attachments_title">Anexos inseguros</string>
+    <string name="general_preference_allow_untrusted_attachments_summary">Permitir download / upload de ficheiros inseguros.</string>
 </resources>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index ce74d34..716c761 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -1176,6 +1176,11 @@ as <xliff:g id="filename">%s</xliff:g>.</string>
          to automatically show pictures for [CHAR LIMIT=80] -->
     <string name="trusted_senders_cleared">\"Show pictures\" cleared.</string>
 
+    <!--  Settings screen, allow untrusted attachments title -->
+    <string name="general_preference_allow_untrusted_attachments_title">Untrusted attachements</string>
+    <!--  Settings screen, allow untrusted attachments summary -->
+    <string name="general_preference_allow_untrusted_attachments_summary">Allow upload / download of untrusted filetypes.</string>
+
     <!-- Generic string for "current position" / "total number" [CHAR LIMIT=12] -->
     <string name="position_of_count"><xliff:g example="1">%1$d</xliff:g> of <xliff:g
             example="12">%2$s</xliff:g></string>
diff --git a/res/xml/general_preferences.xml b/res/xml/general_preferences.xml
index 93beefb..d603949 100644
--- a/res/xml/general_preferences.xml
+++ b/res/xml/general_preferences.xml
@@ -50,5 +50,12 @@
             android:title="@string/general_preferences_clear_trusted_senders_title"
             android:summary="@string/general_preferences_clear_trusted_senders_summary" />
 
+        <CheckBoxPreference
+            android:key="allow_untrusted_attachments"
+            android:persistent="true"
+            android:defaultValue="false"
+            android:title="@string/general_preference_allow_untrusted_attachments_title"
+            android:summary="@string/general_preference_allow_untrusted_attachments_summary" />
+
     </PreferenceCategory>
 </PreferenceScreen>
diff --git a/src/com/android/email/AttachmentInfo.java b/src/com/android/email/AttachmentInfo.java
index cedb63e..16d73a2 100644
--- a/src/com/android/email/AttachmentInfo.java
+++ b/src/com/android/email/AttachmentInfo.java
@@ -20,6 +20,7 @@ import com.android.emailcommon.internet.MimeUtility;
 import com.android.emailcommon.provider.EmailContent.Attachment;
 import com.android.emailcommon.utility.AttachmentUtilities;
 import com.android.emailcommon.utility.Utility;
+import com.android.email.Preferences;
 
 import android.content.Context;
 import android.content.Intent;
@@ -30,6 +31,7 @@ import android.net.ConnectivityManager;
 import android.net.Uri;
 import android.provider.Settings;
 import android.text.TextUtils;
+import android.content.SharedPreferences;
 
 import java.util.List;
 
@@ -80,6 +82,8 @@ public class AttachmentInfo {
     public final boolean mAllowInstall;
     /** Reason(s) why this attachment is denied from being viewed */
     public final int mDenyFlags;
+    /** Access to Shared Preferences */
+    public final SharedPreferences mSharedPreferences;
 
     public AttachmentInfo(Context context, Attachment attachment) {
         this(context, attachment.mId, attachment.mSize, attachment.mFileName, attachment.mMimeType,
@@ -105,6 +109,7 @@ public class AttachmentInfo {
         mId = id;
         mAccountKey = accountKey;
         mFlags = flags;
+        mSharedPreferences = Preferences.getSharedPreferences(context);
         boolean canView = true;
         boolean canSave = true;
         boolean canInstall = false;
@@ -115,44 +120,51 @@ public class AttachmentInfo {
             canSave = false;
         }
 
-        // Check for acceptable / unacceptable attachments by MIME-type
-        if ((!MimeUtility.mimeTypeMatches(mContentType,
-                AttachmentUtilities.ACCEPTABLE_ATTACHMENT_VIEW_TYPES)) ||
-            (MimeUtility.mimeTypeMatches(mContentType,
-                    AttachmentUtilities.UNACCEPTABLE_ATTACHMENT_VIEW_TYPES))) {
-            canView = false;
-        }
+        /**
+         * Check if untrusted attachments are allowed or not
+         */
+        if (!mSharedPreferences.getBoolean(Preferences.ALLOW_UNTRUSTED_ATTACHMENTS,
+                Preferences.ALLOW_UNTRUSTED_ATTACHMENTS_DEFAULT)) {
+
+            // Check for acceptable / unacceptable attachments by MIME-type
+            if ((!MimeUtility.mimeTypeMatches(mContentType,
+                    AttachmentUtilities.ACCEPTABLE_ATTACHMENT_VIEW_TYPES)) ||
+                (MimeUtility.mimeTypeMatches(mContentType,
+                        AttachmentUtilities.UNACCEPTABLE_ATTACHMENT_VIEW_TYPES))) {
+                canView = false;
+            }
 
-        // Check for unacceptable attachments by filename extension
-        String extension = AttachmentUtilities.getFilenameExtension(mName);
-        if (!TextUtils.isEmpty(extension) &&
-                Utility.arrayContains(AttachmentUtilities.UNACCEPTABLE_ATTACHMENT_EXTENSIONS,
-                        extension)) {
-            canView = false;
-            canSave = false;
-            denyFlags |= DENY_MALWARE;
-        }
+            // Check for unacceptable attachments by filename extension
+            String extension = AttachmentUtilities.getFilenameExtension(mName);
+            if (!TextUtils.isEmpty(extension) &&
+                    Utility.arrayContains(AttachmentUtilities.UNACCEPTABLE_ATTACHMENT_EXTENSIONS,
+                            extension)) {
+                canView = false;
+                canSave = false;
+                denyFlags |= DENY_MALWARE;
+            }
 
-        // Check for policy restrictions on download
-        if ((flags & Attachment.FLAG_POLICY_DISALLOWS_DOWNLOAD) != 0) {
-            canView = false;
-            canSave = false;
-            denyFlags |= DENY_POLICY;
-        }
+            // Check for policy restrictions on download
+            if ((flags & Attachment.FLAG_POLICY_DISALLOWS_DOWNLOAD) != 0) {
+                canView = false;
+                canSave = false;
+                denyFlags |= DENY_POLICY;
+            }
 
-        // Check for installable attachments by filename extension
-        extension = AttachmentUtilities.getFilenameExtension(mName);
-        if (!TextUtils.isEmpty(extension) &&
-                Utility.arrayContains(AttachmentUtilities.INSTALLABLE_ATTACHMENT_EXTENSIONS,
-                        extension)) {
-            boolean sideloadEnabled;
-            sideloadEnabled = Settings.Secure.getInt(context.getContentResolver(),
-                    Settings.Secure.INSTALL_NON_MARKET_APPS, 0 /* sideload disabled */) == 1;
-            canSave &= sideloadEnabled;
-            canView = canSave;
-            canInstall = canSave;
-            if (!sideloadEnabled) {
-                denyFlags |= DENY_NOSIDELOAD;
+            // Check for installable attachments by filename extension
+            extension = AttachmentUtilities.getFilenameExtension(mName);
+            if (!TextUtils.isEmpty(extension) &&
+                    Utility.arrayContains(AttachmentUtilities.INSTALLABLE_ATTACHMENT_EXTENSIONS,
+                            extension)) {
+                boolean sideloadEnabled;
+                sideloadEnabled = Settings.Secure.getInt(context.getContentResolver(),
+                        Settings.Secure.INSTALL_NON_MARKET_APPS, 0 /* sideload disabled */) == 1;
+                canSave &= sideloadEnabled;
+                canView = canSave;
+                canInstall = canSave;
+                if (!sideloadEnabled) {
+                    denyFlags |= DENY_NOSIDELOAD;
+                }
             }
         }
 
diff --git a/src/com/android/email/Preferences.java b/src/com/android/email/Preferences.java
index fb5ec25..9233394 100644
--- a/src/com/android/email/Preferences.java
+++ b/src/com/android/email/Preferences.java
@@ -74,6 +74,11 @@ public class Preferences {
     // Reply All Default - when changing this, be sure to update general_preferences.xml
     public static final boolean REPLY_ALL_DEFAULT = false;
 
+    // ALLOW_UNTRUSTED_ATTACHMENTS is saved by the framework (CheckBoxPreference's parent, Preference).
+    public static final String ALLOW_UNTRUSTED_ATTACHMENTS = "allow_untrusted_attachments";
+    // Allow Untrusted attachments Default - when changing this, be sure to update general_preferences.xml
+    public static final boolean ALLOW_UNTRUSTED_ATTACHMENTS_DEFAULT = false;
+
     private static Preferences sPreferences;
 
     private final SharedPreferences mSharedPreferences;
-- 
1.7.9.5

