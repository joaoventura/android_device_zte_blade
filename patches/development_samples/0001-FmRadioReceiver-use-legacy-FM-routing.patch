From 13bf1e5fa7f663437939a8e81725e5f58cda5acf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jo=C3=A3o=20Ventura?= <joaojonesventura@gmail.com>
Date: Wed, 13 Mar 2013 14:42:18 +0000
Subject: [PATCH] FmRadioReceiver use legacy FM routing

Change-Id: I64a338318eae0a4224cf86b496b1fcd091d9aabd
---
 samples/FmRadioReceiver/AndroidManifest.xml        |   25 ++++++++++----------
 .../android/fmradioreceiver/FmRadioReceiver.java   |   14 ++++++++++-
 2 files changed, 26 insertions(+), 13 deletions(-)

diff --git a/samples/FmRadioReceiver/AndroidManifest.xml b/samples/FmRadioReceiver/AndroidManifest.xml
index f1aae65..762f6f3 100755
--- a/samples/FmRadioReceiver/AndroidManifest.xml
+++ b/samples/FmRadioReceiver/AndroidManifest.xml
@@ -1,15 +1,16 @@
 <?xml version="1.0" encoding="utf-8"?>
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
-	package="com.example.android.fmradioreceiver" android:versionCode="1"
-	android:versionName="1.0">
-	<application android:icon="@drawable/icon" android:label="@string/app_name">
-		<activity android:name=".FmRadioReceiver" android:label="@string/app_name">
-			<intent-filter>
-				<action android:name="android.intent.action.MAIN" />
-				<category android:name="android.intent.category.LAUNCHER" />
-			</intent-filter>
-		</activity>
-	</application>
-	<uses-permission android:name="com.stericsson.permission.FM_RADIO_TRANSMITTER"></uses-permission>
-	<uses-permission android:name="com.stericsson.permission.FM_RADIO_RECEIVER"></uses-permission>
+    package="com.example.android.fmradioreceiver" android:versionCode="1"
+    android:versionName="1.0">
+    <application android:icon="@drawable/icon" android:label="@string/app_name">
+        <activity android:name=".FmRadioReceiver" android:label="@string/app_name">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.LAUNCHER" />
+            </intent-filter>
+        </activity>
+    </application>
+    <uses-permission android:name="com.stericsson.permission.FM_RADIO_TRANSMITTER"></uses-permission>
+    <uses-permission android:name="com.stericsson.permission.FM_RADIO_RECEIVER"></uses-permission>
+    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"></uses-permission>
 </manifest>
diff --git a/samples/FmRadioReceiver/src/com/example/android/fmradioreceiver/FmRadioReceiver.java b/samples/FmRadioReceiver/src/com/example/android/fmradioreceiver/FmRadioReceiver.java
index 269dd84..854c297 100755
--- a/samples/FmRadioReceiver/src/com/example/android/fmradioreceiver/FmRadioReceiver.java
+++ b/samples/FmRadioReceiver/src/com/example/android/fmradioreceiver/FmRadioReceiver.java
@@ -33,6 +33,8 @@ import android.widget.TextView;
 import android.widget.Toast;
 import com.stericsson.hardware.fm.FmBand;
 import com.stericsson.hardware.fm.FmReceiver;
+import android.media.AudioManager;
+import android.media.AudioSystem;
 
 import java.io.IOException;
 
@@ -94,6 +96,8 @@ public class FmRadioReceiver extends Activity {
     // Array of the available stations in MHz
     private ArrayAdapter<CharSequence> mMenuAdapter;
 
+    private AudioManager audioman;
+
     // The name of the storage string
     public static final String PREFS_NAME = "FMRadioPrefsFile";
 
@@ -128,6 +132,8 @@ public class FmRadioReceiver extends Activity {
         SharedPreferences settings = getSharedPreferences(PREFS_NAME, 0);
         mSelectedBand = settings.getInt("selectedBand", 1);
         mFmBand = new FmBand(mSelectedBand);
+        audioman = (AudioManager)getSystemService(Context.AUDIO_SERVICE);
+        setVolumeControlStream(AudioManager.STREAM_MUSIC);
         setupButtons();
     }
 
@@ -258,6 +264,8 @@ public class FmRadioReceiver extends Activity {
             mMediaPlayer.release();
             mMediaPlayer = null;
         }
+        AudioSystem.setDeviceConnectionState(AudioSystem.DEVICE_OUT_FM, AudioSystem.DEVICE_STATE_UNAVAILABLE, "");
+        audioman.setParameters("fm_off=1");
     }
 
     /**
@@ -319,7 +327,11 @@ public class FmRadioReceiver extends Activity {
             mMediaPlayer.prepare();
             mMediaPlayer.start();
         } catch (IOException e) {
-            showToast("Unable to start the media player", Toast.LENGTH_LONG);
+            //showToast("Unable to start the media player", Toast.LENGTH_LONG);
+            Log.d(LOG_TAG, "Unable to start the media player, fall back to legacy audio routing");
+            AudioSystem.setDeviceConnectionState(AudioSystem.DEVICE_OUT_FM, AudioSystem.DEVICE_STATE_UNAVAILABLE, "");
+            AudioSystem.setDeviceConnectionState(AudioSystem.DEVICE_OUT_FM, AudioSystem.DEVICE_STATE_AVAILABLE, "");
+            audioman.setParameters("fm_on=1");
         }
     }
 
-- 
1.7.10.4

